## 1) 默认大小是多少？能改吗？

* **默认大小：`4`**（4 个 worker 线程）。
* 可通过环境变量调整：`UV_THREADPOOL_SIZE`

  * 需要在 **Node 进程启动前**设置（运行中改没用）。
  * 常见范围：`4 ~ 64`（具体看机器核数、负载类型）。
  * 上限：libuv 允许到 **1024**（但不建议盲目拉满）。

> 关键点：这 4 个线程不是给 JS 执行用的，**JS 仍然在主线程跑**。线程池只负责“某些无法纯事件驱动的异步工作”。

---

## 2) 线程池到底用来干什么？（适用场景）

libuv 线程池主要承担两类事情：

### A. **文件系统类（fs）**

很多 `fs.*` 的异步版本（尤其是磁盘读写）会丢到线程池里做，因为多数平台的文件 IO 并不像网络 IO 那样天然事件驱动。

典型：

* `fs.readFile`, `fs.writeFile`, `fs.stat`, `fs.readdir`, `fs.realpath` 等（大多会用到线程池）

**含义**：如果你并发做大量 fs 操作，**会把线程池塞满**。

---

### B. **加密/压缩等“可异步化”的计算类（crypto 等）**

`crypto` 里一些“计算很重但提供异步 API”的函数，会在后台线程跑，避免主线程卡死：

典型（常见会进线程池的）：

* `crypto.pbkdf2`
* `crypto.scrypt`
* 以及部分 OpenSSL 相关的异步操作

**含义**：高并发密码哈希（登录/注册、批量校验）很容易把线程池打满。

> 补充：`crypto.createHash(...).update(...).digest(...)` 这类**同步**用法是直接在主线程算的，不走线程池——会阻塞事件循环。

---

### C. **DNS（dns）——特别容易被误判**

这里最关键的是：**dns 模块有两套路径**：

1. `dns.lookup()`

* 通常走系统解析（`getaddrinfo`），**会使用 libuv 线程池**。

2. `dns.resolve*()`（如 `dns.resolve4/6`, `dns.resolveTxt` 等）

* 走 c-ares（自己发 DNS 查询），**一般不走线程池**。

**含义**：

* 你如果在高并发下频繁 `dns.lookup`，会和 `fs/crypto` 抢同一个线程池，互相拖慢。
* 这也是线上常见“请求偶发抖动/超时”的来源之一。

---

## 3) 为什么会“互相拖慢”？

因为 **fs/crypto/dns.lookup 共享同一个固定大小的线程池**。

举个典型事故链路：

* 你在高峰期做了大量 `pbkdf2`（密码哈希）
* 同时 SSR / BFF 又在读模板/读配置（fs）
* 再加上新建连接频繁触发 `dns.lookup`
  ➡️ 线程池只有 4 个 worker：队列排队变长
  ➡️ 表现为：**接口随机变慢、整体延迟抖动、甚至超时**
  而 CPU 主线程未必满，所以“看起来不忙但就是慢”。

---

## 4) 怎么判断线程池成为瓶颈？

常见信号：

* 延迟抖动明显：P95/P99 飘得厉害
* CPU 主线程不高，但请求排队/超时
* `fs`/`crypto`/`dns.lookup` 的回调“迟迟不回来”

更工程化的做法：

* 用 `perf_hooks.monitorEventLoopDelay()` 看事件循环是否被阻塞（主线程问题）
* 如果事件循环不高但延迟高，**高度怀疑线程池排队**

---

## 5) 该不该调大 UV_THREADPOOL_SIZE？怎么调才对？

### 什么时候值得调大

* 你明确存在 **高并发 fs**（比如大量读写、日志处理、模板读取）
* 或 **高并发 crypto**（pbkdf2/scrypt/bcrypt 等）
* 或 **大量 dns.lookup**（尤其是短连接、频繁新建连接）

### 调大有什么副作用

* 线程越多：上下文切换/内存占用更高
* fs 类任务受磁盘吞吐限制：线程再多也可能只是在“更多排队 + 更多争用”
* crypto 类任务受 CPU 限制：线程太多可能导致整体更抖

### 经验建议（实战）

* 默认 4 通常偏小；**IO-heavy + crypto-heavy** 的服务常会设到 **16/32** 起步做压测验证。
* **一定要压测**：看 P95/P99、错误率、CPU、load、以及请求队列长度变化。
* 更推荐的架构手段：

  * crypto 重任务：丢到 **worker_threads** 或独立服务
  * DNS：尽量减少 `dns.lookup` 频率（连接复用、keep-alive、减少短连接）

---
