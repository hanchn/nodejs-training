## timers / pending callbacks / idle-prepare / poll / check / close callbacks

![Image](https://media.geeksforgeeks.org/wp-content/uploads/20200224050909/nodejs2.png)

![Image](https://miro.medium.com/1%2A06MfOTbNnZfquakphon2SQ.jpeg)

![Image](https://miro.medium.com/1%2A_Ve2EdFOq_M6BTROYAOFSQ.png)

---

## ä¸€ã€å…ˆç»™ä½ ä¸€å¼ â€œæ‰§è¡Œé¡ºåºå¿ƒæ™ºå›¾â€ï¼ˆä¸€å®šè¦è®°ä½ï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ timers            (setTimeout)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pending callbacks             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ idle / prepare                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ poll              (IO)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ check             (setImmediate)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ close callbacks               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âš ï¸ **ä½†è¿™ä¸æ˜¯å®Œæ•´æ•…äº‹**
åœ¨æ¯ä¸ªé˜¶æ®µä¹‹é—´ï¼Œè¿˜ä¼šè¢«**ä¸¤ç§â€œæ’é˜Ÿæœºåˆ¶â€æ‰“æ–­**ï¼š

```text
process.nextTick  ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
Promise.then      ï¼ˆmicrotaskï¼‰
```

---

## äºŒã€timers é˜¶æ®µï¼ˆsetTimeout / setIntervalï¼‰

### 1ï¸âƒ£ timers åœ¨å¹²ä»€ä¹ˆï¼Ÿ

* æ‰§è¡Œ **åˆ°æœŸçš„å®šæ—¶å™¨å›è°ƒ**
* `setTimeout(fn, x)`
  â‰  x ms åâ€œç«‹åˆ»æ‰§è¡Œâ€

```js
setTimeout(() => {
  console.log('timeout')
}, 0)
```

ğŸ‘‰ æ„å‘³ç€ï¼š

> **æœ€æ—©åœ¨ä¸‹ä¸€è½® timers é˜¶æ®µæ‰§è¡Œ**

---

### 2ï¸âƒ£ å¸¸è§è¯¯è§£ï¼ˆçº¿ä¸Šé«˜é¢‘ï¼‰

âŒ è¯¯è§£ï¼š

> setTimeout(fn, 0) æ˜¯â€œç«‹åˆ»æ‰§è¡Œâ€

âœ… çœŸç›¸ï¼š

* å½“å‰äº‹ä»¶å¾ªç¯å¿…é¡»ç»“æŸ
* poll é˜¶æ®µå¿…é¡»è®©å‡º
* æ‰èƒ½å›åˆ° timers

---

### 3ï¸âƒ£ å·¥ç¨‹ç»“è®º

* timers **ä¸ä¿è¯ç²¾åº¦**
* åªä¿è¯ **â€œä¸æ—©äºâ€**

---

## ä¸‰ã€pending callbacks é˜¶æ®µï¼ˆå¾ˆå°‘è¢«æï¼Œä½†çœŸå®å­˜åœ¨ï¼‰

### 1ï¸âƒ£ å®ƒæ˜¯å¹²å˜›çš„ï¼Ÿ

å¤„ç†ä¸€äº› **ç³»ç»Ÿçº§å»¶è¿Ÿå›è°ƒ**ï¼Œæ¯”å¦‚ï¼š

* TCP é”™è¯¯
* æŸäº› OS å¼‚å¸¸

ğŸ‘‰ **ä¸æ˜¯ä½ æ—¥å¸¸ä¸šåŠ¡èƒ½ç›´æ¥æ§åˆ¶çš„**

---

### 2ï¸âƒ£ å·¥ç¨‹è§†è§’

* ä¸å†™ä¸šåŠ¡é€»è¾‘
* åªçŸ¥é“å®ƒå­˜åœ¨å³å¯
* ä¸è¦æŒ‡æœ› hook å®ƒ

---

## å››ã€idle / prepare é˜¶æ®µï¼ˆlibuv å†…éƒ¨é˜¶æ®µï¼‰

### 1ï¸âƒ£ è¿™ä¸ªé˜¶æ®µä½ èƒ½ç”¨å—ï¼Ÿ

ä¸èƒ½ã€‚

### 2ï¸âƒ£ å®ƒçš„ä½œç”¨

* libuv å†…éƒ¨ bookkeeping
* ä¸º poll é˜¶æ®µåšå‡†å¤‡

ğŸ‘‰ **çº¯å†…éƒ¨é˜¶æ®µ**

---

## äº”ã€poll é˜¶æ®µï¼ˆæ•´ä¸ª Node çš„â€œå¿ƒè„â€ï¼‰

> **80% çš„ Node æ€§èƒ½é—®é¢˜ï¼Œéƒ½å’Œ poll æœ‰å…³**

---

### 1ï¸âƒ£ poll åœ¨å¹²ä»€ä¹ˆï¼Ÿ

* ç­‰å¾…æ–°çš„ IOï¼ˆsocket / fs / dnsï¼‰
* æ‰§è¡Œ IO å›è°ƒ
* å†³å®šï¼š

  * æ˜¯ç»§ç»­ç­‰ï¼Ÿ
  * è¿˜æ˜¯è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Ÿ

---

### 2ï¸âƒ£ poll çš„ä¸‰ç§å…³é”®è¡Œä¸ºï¼ˆå¿…é¡»ç†è§£ï¼‰

#### âœ… æƒ…å†µ 1ï¼šæœ‰ IO å›è°ƒ

```text
poll â†’ æ‰§è¡Œ IO å›è°ƒ
```

---

#### âœ… æƒ…å†µ 2ï¼šæ²¡ IOï¼Œä½†æœ‰ setImmediate

```text
poll â†’ ç«‹å³è¿›å…¥ check
```

---

#### âœ… æƒ…å†µ 3ï¼šæ²¡ IOï¼Œä¹Ÿæ²¡ setImmediate

```text
poll â†’ é˜»å¡ç­‰å¾… IO
```

ğŸ‘‰ **è¿™æ˜¯ Node é«˜æ•ˆçš„æ ¹æœ¬åŸå› **

---

### 3ï¸âƒ£ ä¸€ä¸ªæå…¶é‡è¦çš„ç»“è®º

> **Node ä¸æ˜¯ä¸€ç›´åœ¨â€œè·‘â€**
> **å®ƒå¤§éƒ¨åˆ†æ—¶é—´æ˜¯åœ¨ poll é˜¶æ®µâ€œç­‰ IOâ€**

---

## å…­ã€check é˜¶æ®µï¼ˆsetImmediate çš„ä¸“å±èˆå°ï¼‰

### 1ï¸âƒ£ check é˜¶æ®µåªå¹²ä¸€ä»¶äº‹

> **æ‰§è¡Œ setImmediate æ³¨å†Œçš„å›è°ƒ**

```js
setImmediate(() => {
  console.log('immediate')
})
```

---

### 2ï¸âƒ£ setImmediate vs setTimeout(0)

| åœºæ™¯     | è°å…ˆæ‰§è¡Œ           |
| ------ | -------------- |
| æ™®é€šè„šæœ¬   | ä¸ç¡®å®š            |
| IO å›è°ƒä¸­ | setImmediate âœ… |

```js
fs.readFile('a.txt', () => {
  setTimeout(() => console.log('timeout'), 0)
  setImmediate(() => console.log('immediate'))
})
```

è¾“å‡ºï¼š

```text
immediate
timeout
```

ğŸ‘‰ **è¿™æ˜¯é¢è¯• & çº¿ä¸Šå®šä½å¿…è€ƒç‚¹**

---

## ä¸ƒã€close callbacks é˜¶æ®µï¼ˆèµ„æºå–„åï¼‰

### 1ï¸âƒ£ ä»€ä¹ˆä¼šè¿› close callbacksï¼Ÿ

* socket.close
* stream.destroy
* handle è¢«æ˜¾å¼å…³é—­

---

### 2ï¸âƒ£ å·¥ç¨‹æ„ä¹‰

* æ¸…ç†èµ„æº
* ä¸è¦æ”¾ä¸šåŠ¡é€»è¾‘
* ä¸ä¿è¯æ‰§è¡Œæ—¶æœºç²¾ç¡®

---

## å…«ã€ä¸¤ç§â€œæ’é˜Ÿæœºåˆ¶â€ï¼ˆæ¯”é˜¶æ®µæ›´é‡è¦ï¼‰

### 1ï¸âƒ£ process.nextTickï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

```js
process.nextTick(() => {
  console.log('tick')
})
```

* **ä¸å±äº event loop é˜¶æ®µ**
* æ¯ä¸ªé˜¶æ®µç»“æŸéƒ½ä¼šå…ˆæ¸…ç©º nextTick é˜Ÿåˆ—

âŒ æ»¥ç”¨åæœï¼š

```js
while (true) {
  process.nextTick(fn)
}
```

ğŸ‘‰ **äº‹ä»¶å¾ªç¯è¢«é¥¿æ­»ï¼ŒIO æ°¸è¿œä¸æ‰§è¡Œ**

---

### 2ï¸âƒ£ Promise.thenï¼ˆmicrotaskï¼‰

```js
Promise.resolve().then(() => {
  console.log('micro')
})
```

* åœ¨ **å½“å‰é˜¶æ®µç»“æŸå**
* åœ¨è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µå‰æ‰§è¡Œ

ä¼˜å…ˆçº§ï¼š

```text
nextTick > Promise.then > Event Loop é˜¶æ®µ
```

---

## ä¹ã€å®Œæ•´æ‰§è¡Œé¡ºåºï¼ˆç»ˆæç‰ˆï¼‰

```text
åŒæ­¥ä»£ç 
â†“
process.nextTick
â†“
Promise.then (microtask)
â†“
timers
â†“
pending callbacks
â†“
idle / prepare
â†“
poll
â†“
check
â†“
close callbacks
â†“
process.nextTick
â†“
Promise.then
â†“
ä¸‹ä¸€è½® event loop
```

---

## åã€ä¸ºä»€ä¹ˆè¿™äº›ä¸œè¥¿åœ¨â€œçº¿ä¸Šç‰¹åˆ«é‡è¦â€ï¼Ÿ

### ä½ è§è¿‡è¿™äº›é—®é¢˜å—ï¼Ÿ

* Promise å†™å¤šäº†ï¼ŒIO å˜æ…¢
* setTimeout(0) ä¸æ‰§è¡Œ
* CPU ä¸é«˜ï¼Œä½†æ¥å£å¾ˆæ…¢
* fs å›è°ƒå»¶è¿Ÿå¼‚å¸¸

ğŸ‘‰ **ç­”æ¡ˆéƒ½åœ¨äº‹ä»¶å¾ªç¯**

---

## åä¸€ã€Node æœåŠ¡ç«¯çš„â€œäº‹ä»¶å¾ªç¯é“å¾‹â€

### âŒ ç¦æ­¢

* while + nextTick
* å¤§é‡åŒæ­¥é€»è¾‘
* åœ¨ poll å›è°ƒé‡Œåšé‡è®¡ç®—

---

### âœ… æ¨è

* IO å›è°ƒåªåšè°ƒåº¦
* CPU ä»»åŠ¡ä¸¢ worker
* ç”¨ perf_hooks ç›‘æ§ event loop delay

---

## åäºŒã€ä¸€å¥è¯æ€»ç»“ï¼ˆå¯ä»¥ç›´æ¥å†™è¿›æ•™ç¨‹ï¼‰

> **timers å†³å®šâ€œä½•æ—¶èƒ½è½®åˆ°ä½ â€
> poll å†³å®šâ€œç³»ç»Ÿåœ¨å¿™ä»€ä¹ˆâ€
> check å†³å®šâ€œIO åç«‹åˆ»å¹²ä»€ä¹ˆâ€
> nextTick / Promise å†³å®šâ€œè°èƒ½æ’é˜Ÿâ€**

