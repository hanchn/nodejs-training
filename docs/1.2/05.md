# CommonJS vs ESMï¼ˆNode.js çœŸå®žè¯­ä¹‰å¯¹æ¯”ï¼‰

## åŠ è½½é¡ºåº Â· å¾ªçŽ¯ä¾èµ– Â· äº’æ“ä½œ

> **æ¨¡å—ç³»ç»Ÿä¸æ˜¯â€œå†™æ³•å·®å¼‚â€ï¼Œè€Œæ˜¯æ‰§è¡Œæ¨¡åž‹å·®å¼‚**
> å¾ˆå¤š Node çº¿ä¸Š Bugï¼Œæœ¬è´¨å°±æ˜¯æ¨¡å—è¯­ä¹‰ç†è§£é”™äº†ã€‚

---

## ä¸€ã€æœ€æ ¸å¿ƒçš„ä¸€å¥è¯åŒºåˆ«ï¼ˆå…ˆè®°ä½ï¼‰

| ç»´åº¦      | CommonJS  | ESM       |
| ------- | --------- | --------- |
| åŠ è½½æ—¶æœº    | **è¿è¡Œæ—¶åŠ è½½** | **ç¼–è¯‘æœŸè§£æž** |
| å¯¼å‡ºè¯­ä¹‰    | å€¼æ‹·è´       | å¼•ç”¨ç»‘å®š      |
| å¾ªçŽ¯ä¾èµ–    | è¿”å›žâ€œåŠæˆå“â€   | æœ‰æ˜Žç¡® TDZ   |
| Node åŽ†å² | é»˜è®¤        | æ–°æ ‡å‡†       |

---

## äºŒã€åŠ è½½é¡ºåºï¼šè¿™æ˜¯ä¸€åˆ‡å·®å¼‚çš„æºå¤´

### 1ï¸âƒ£ CommonJS çš„åŠ è½½é¡ºåºï¼ˆrequireï¼‰

```js
const a = require('./a')
```

Node çš„è¡Œä¸ºæ˜¯ï¼š

```text
1. ç«‹å³æ‰§è¡Œ a.js
2. æ‰§è¡Œåˆ° module.exports
3. ç¼“å­˜ exports
4. è¿”å›ž exports å¼•ç”¨
```

ðŸ‘‰ **è¾¹æ‰§è¡Œï¼Œè¾¹å¯¼å‡º**

---

### 2ï¸âƒ£ ESM çš„åŠ è½½é¡ºåºï¼ˆimportï¼‰

```js
import { a } from './a.js'
```

ESM çš„è¡Œä¸ºæ˜¯ï¼š

```text
1. å…ˆæ‰«ææ‰€æœ‰ import / exportï¼ˆä¸æ‰§è¡Œä»£ç ï¼‰
2. æž„å»ºæ¨¡å—ä¾èµ–å›¾
3. ç¡®å®šæ‰§è¡Œé¡ºåº
4. å†ç»Ÿä¸€æ‰§è¡Œæ¨¡å—ä»£ç 
```

ðŸ‘‰ **å…ˆâ€œçœ‹æ¸…å…¨å±€â€ï¼Œå†æ‰§è¡Œ**

---

### 3ï¸âƒ£ ä¸€ä¸ªéžå¸¸é‡è¦çš„å·¥ç¨‹ç»“è®º

> **ESM èƒ½åœ¨â€œæ‰§è¡Œå‰â€å‘çŽ°é—®é¢˜
> CommonJS åªèƒ½åœ¨â€œè·‘èµ·æ¥åŽâ€æš´éœ²é—®é¢˜**

---

## ä¸‰ã€å¾ªçŽ¯ä¾èµ–ï¼šNode æœåŠ¡ç«¯çš„é«˜å±ç‚¹

### 1ï¸âƒ£ CommonJS çš„å¾ªçŽ¯ä¾èµ–ï¼ˆæœ€å±é™©ï¼‰

```js
// a.js
const b = require('./b')
exports.a = 'A'

// b.js
const a = require('./a')
console.log(a.a)
exports.b = 'B'
```

æ‰§è¡Œè¿‡ç¨‹ï¼š

```text
require a
â†’ æ‰§è¡Œ a.js
â†’ require b
  â†’ æ‰§è¡Œ b.js
  â†’ require aï¼ˆå·²ç¼“å­˜ï¼‰
  â†’ è¿”å›ž a çš„â€œå½“å‰ exportsâ€ï¼ˆæœªå®Œæˆï¼‰
```

ðŸ‘‰ `a.a === undefined`

â— **ä¸ä¼šæŠ¥é”™ï¼Œä½†ç»“æžœæ˜¯é”™çš„**

---

### 2ï¸âƒ£ ESM çš„å¾ªçŽ¯ä¾èµ–ï¼ˆæ›´å®‰å…¨ï¼‰

```js
// a.js
import { b } from './b.js'
export const a = 'A'

// b.js
import { a } from './a.js'
console.log(a)
export const b = 'B'
```

è¡Œä¸ºç‰¹ç‚¹ï¼š

* import æ˜¯ **live binding**
* å¦‚æžœè®¿é—®æœªåˆå§‹åŒ–å˜é‡ â†’ **ç›´æŽ¥æŠ¥é”™ï¼ˆTDZï¼‰**

ðŸ‘‰ **ESM æŠŠé—®é¢˜æš´éœ²å¾—éžå¸¸æ—©**

---

### 3ï¸âƒ£ æœåŠ¡ç«¯ç»“è®ºï¼ˆéžå¸¸é‡è¦ï¼‰

| æ¨¡å—ç³»ç»Ÿ     | å¾ªçŽ¯ä¾èµ–é£Žé™©      |
| -------- | ----------- |
| CommonJS | âŒ éšè”½ã€å±é™©     |
| ESM      | âš ï¸ ç›´æŽ¥å¤±è´¥ã€å¥½æŽ’æŸ¥ |

---

## å››ã€å¯¼å‡ºè¯­ä¹‰ï¼šå€¼æ‹·è´ vs å¼•ç”¨ç»‘å®š

### 1ï¸âƒ£ CommonJSï¼šå¯¼å‡ºçš„æ˜¯â€œå€¼â€

```js
// a.js
let count = 0
module.exports = { count }
setTimeout(() => count++, 1000)

// b.js
const { count } = require('./a')
```

â— `count` **ä¸ä¼šå˜**

å› ä¸ºï¼š

* è§£æž„çš„æ˜¯å€¼
* ä¸æ˜¯ live binding

---

### 2ï¸âƒ£ ESMï¼šå¯¼å‡ºçš„æ˜¯â€œå¼•ç”¨â€

```js
// a.js
export let count = 0
setTimeout(() => count++, 1000)

// b.js
import { count } from './a.js'
```

ðŸ‘‰ `count` ä¼šå˜åŒ–

---

### 3ï¸âƒ£ Node å·¥ç¨‹å½±å“

| åœºæ™¯    | CommonJS | ESM    |
| ----- | -------- | ------ |
| åŠ¨æ€çŠ¶æ€  | æ˜“è¸©å‘      | è¯­ä¹‰æ¸…æ™°   |
| é…ç½®    | å®‰å…¨       | å®‰å…¨     |
| è¯·æ±‚æ€æ•°æ® | âŒ å±é™©     | âŒ ä»ç„¶å±é™© |

> â— **ESM è§£å†³ä¸äº†â€œæ¨¡å—çº§çŠ¶æ€å…±äº«â€è¿™ä¸ªé—®é¢˜**

---

## äº”ã€äº’æ“ä½œç­–ç•¥ï¼ˆè¿™æ˜¯ä½ ä¸€å®šä¼šé‡åˆ°çš„ï¼‰

### 1ï¸âƒ£ åœ¨ CommonJS ä¸­ç”¨ ESM

```js
// cjs
(async () => {
  const mod = await import('./esm.js')
})()
```

é™åˆ¶ï¼š

* import æ˜¯å¼‚æ­¥
* ä¸èƒ½é¡¶å±‚ import

---

### 2ï¸âƒ£ åœ¨ ESM ä¸­ç”¨ CommonJSï¼ˆæœ€å¸¸è§ï¼‰

```js
import pkg from 'lodash'
```

Node è¡Œä¸ºï¼š

* æŠŠ `module.exports` å½“æˆ default export

```js
const lodash = require('lodash')
```

ç­‰ä»·äºŽï¼š

```js
import lodash from 'lodash'
```

---

### 3ï¸âƒ£ æ··ç”¨æ—¶æœ€å®¹æ˜“è¸©çš„å‘

```js
// cjs.js
module.exports = { foo: 1 }

// esm.js
import { foo } from './cjs.js' // âŒ
```

âŒ æŠ¥é”™ï¼š`foo is undefined`

âœ… æ­£ç¡®å†™æ³•ï¼š

```js
import pkg from './cjs.js'
const { foo } = pkg
```

---

## å…­ã€Node.js æœåŠ¡ç«¯çš„æŽ¨èç­–ç•¥ï¼ˆå®žæˆ˜ï¼‰

### 1ï¸âƒ£ è€é¡¹ç›®ï¼ˆç¨³å®šä¼˜å…ˆï¼‰

* ç»§ç»­ç”¨ CommonJS
* ç¦æ­¢å¾ªçŽ¯ require
* ç¦æ­¢æ¨¡å—çº§çŠ¶æ€

---

### 2ï¸âƒ£ æ–°é¡¹ç›®ï¼ˆé•¿æœŸç»´æŠ¤ï¼‰

* **ä¼˜å…ˆ ESM**
* æ˜Žç¡® export è¾¹ç•Œ
* å°½é‡ç”¨çº¯å‡½æ•°æ¨¡å—

---

### 3ï¸âƒ£ æ··åˆæœŸï¼ˆéžå¸¸çŽ°å®žï¼‰

* æ¡†æž¶å±‚å¯ CommonJS
* ä¸šåŠ¡å±‚é€æ­¥ ESM
* **ç¦æ­¢åŒå‘äº’ç›¸ import**

---

## ä¸ƒã€ä¸€å¼ â€œçº¿ä¸Šå®‰å…¨é€ŸæŸ¥è¡¨â€ï¼ˆå¼ºçƒˆå»ºè®®è´´æ–‡æ¡£ï¼‰

| é—®é¢˜        | CommonJS | ESM      |
| --------- | -------- | -------- |
| å¾ªçŽ¯ä¾èµ–      | âŒ éšæ€§ Bug | âš ï¸ ç›´æŽ¥å¤±è´¥  |
| åŠ è½½é¡ºåºå¯é¢„æµ‹   | âŒ        | âœ…        |
| åŠ¨æ€ import | require  | import() |
| æ¨¡å—çº§çŠ¶æ€å®‰å…¨   | âŒ        | âŒ        |
| å·¥å…·é“¾æœªæ¥     | âš ï¸       | âœ…        |

---

## å…«ã€ç»™å›¢é˜Ÿçš„ä¸€å¥â€œæž¶æž„çº§å…±è¯†â€

> **CommonJS æ˜¯â€œè¾¹è·‘è¾¹æ‹¼å›¾â€
> ESM æ˜¯â€œå…ˆç”»å›¾ï¼Œå†æ–½å·¥â€**
>
> ä¸¤è€…éƒ½èƒ½ç”¨ï¼Œä½†**å¿…é¡»æ¸…æ¥šè‡ªå·±ç«™åœ¨å“ªä¸€å±‚**

---
