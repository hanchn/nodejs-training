## Node.js æ¶æ„æ€»è§ˆï¼ˆä¸€çœ¼ç‰ˆï¼‰

![Image](https://www.scaler.com/topics/images/node-js-architecture-1.webp)

![Image](https://miro.medium.com/1%2Ao60tEVVfSNI3oHwqhgN2iQ.jpeg)

![Image](https://docs.libuv.org/en/v1.x/_images/architecture.png)

```text
JavaScript ä»£ç 
   â†“
V8ï¼ˆJS å¼•æ“ï¼‰
   â†“
C++ Bindingsï¼ˆæ¡¥æ¥å±‚ï¼‰
   â†“
libuvï¼ˆäº‹ä»¶å¾ªç¯ / çº¿ç¨‹æ± ï¼‰
   â†“
æ“ä½œç³»ç»Ÿï¼ˆç½‘ç»œ / æ–‡ä»¶ / å®šæ—¶å™¨ï¼‰
```

ä¸€å¥è¯æ€»ç»“ï¼š

> **V8 è´Ÿè´£â€œç®— JSâ€
> libuv è´Ÿè´£â€œç­‰ IOâ€
> C++ bindings è´Ÿè´£â€œæŠŠä¸¤è€…æ¥èµ·æ¥â€**

---

## ä¸€ã€V8ï¼šNode çš„â€œè®¡ç®—å¤§è„‘â€

### 1ï¸âƒ£ V8 åœ¨ Node é‡Œå¹²ä»€ä¹ˆï¼Ÿ

V8 åªåšä¸€ä»¶äº‹ï¼š

> **æ‰§è¡Œ JavaScript ä»£ç **

åŒ…æ‹¬ï¼š

* è§£æ JS
* JIT ç¼–è¯‘ï¼ˆIgnition â†’ TurboFanï¼‰
* æ‰§è¡ŒåŒæ­¥ JS
* åƒåœ¾å›æ”¶ï¼ˆGCï¼‰

---

### 2ï¸âƒ£ éå¸¸é‡è¦çš„è¾¹ç•Œï¼ˆNode æ€§èƒ½æ ¸å¿ƒï¼‰

> â— **V8 æ˜¯å•çº¿ç¨‹çš„**

æ„å‘³ç€ï¼š

* åŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ®µ JS
* **ä»»ä½•åŒæ­¥ JS éƒ½ä¼šé˜»å¡æ•´ä¸ª Node è¿›ç¨‹**

```js
while (true) {} // é˜»å¡ V8 = é˜»å¡æ•´ä¸ªæœåŠ¡
```

ğŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š

* Node ä¸æ€•å¹¶å‘ IO
* Node éå¸¸æ€• CPU å¯†é›†

---

### 3ï¸âƒ£ V8 ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ IO

V8ï¼š

* ä¸æ‡‚ socket
* ä¸æ‡‚æ–‡ä»¶
* ä¸æ‡‚ epoll / kqueue

ğŸ‘‰ **IO ä¸æ˜¯ V8 çš„èƒ½åŠ›èŒƒå›´**

---

## äºŒã€libuvï¼šNode çš„â€œå¹¶å‘ä¸ç­‰å¾…å¼•æ“â€

### 1ï¸âƒ£ libuv æ˜¯ä»€ä¹ˆï¼Ÿ

> **libuv æ˜¯ Node çš„åº•å±‚å¹¶å‘åº“**

å®ƒè´Ÿè´£ï¼š

* äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰
* å¼‚æ­¥ IO æŠ½è±¡
* è·¨å¹³å°é€‚é…ï¼ˆLinux / macOS / Windowsï¼‰
* çº¿ç¨‹æ± ç®¡ç†

---

### 2ï¸âƒ£ libuv è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

æ“ä½œç³»ç»Ÿçš„ IO APIï¼š

* Linuxï¼šepoll
* macOSï¼škqueue
* Windowsï¼šIOCP

libuv åšçš„äº‹ï¼š

> **ç”¨ä¸€å¥—ç»Ÿä¸€æ¥å£ï¼Œå±è”½ OS å·®å¼‚**

---

### 3ï¸âƒ£ libuv çš„ä¸¤ç§ IO æ¨¡å‹ï¼ˆéå¸¸å…³é”®ï¼‰

#### âœ… 1. çœŸå¼‚æ­¥ IOï¼ˆå†…æ ¸æ”¯æŒï¼‰

* ç½‘ç»œ IOï¼ˆTCP / UDPï¼‰
* å®šæ—¶å™¨
* signal

ğŸ‘‰ ç›´æ¥äº¤ç»™ OS äº‹ä»¶é€šçŸ¥
ğŸ‘‰ **ä¸å ç”¨çº¿ç¨‹æ± **

---

#### âš ï¸ 2. çº¿ç¨‹æ± æ¨¡æ‹Ÿå¼‚æ­¥ IO

* æ–‡ä»¶ç³»ç»Ÿï¼ˆfsï¼‰
* DNS
* cryptoï¼ˆéƒ¨åˆ†ï¼‰

```text
JS â†’ libuv â†’ çº¿ç¨‹æ±  â†’ OS
```

é»˜è®¤çº¿ç¨‹æ± å¤§å°ï¼š

```js
UV_THREADPOOL_SIZE = 4
```

ğŸ‘‰ **è¿™å°±æ˜¯ fs/crypto é«˜å¹¶å‘ä¼šå¡çš„åŸå› **

---

## ä¸‰ã€C++ bindingsï¼šNode çš„â€œç¿»è¯‘å®˜â€

### 1ï¸âƒ£ ä¸ºä»€ä¹ˆéœ€è¦ C++ bindingsï¼Ÿ

V8ï¼ˆJSï¼‰ â‰  libuvï¼ˆCï¼‰

ä¸¤è€…è¯­è¨€ã€å†…å­˜æ¨¡å‹å®Œå…¨ä¸åŒ
ğŸ‘‰ **å¿…é¡»æœ‰äººâ€œç¿»è¯‘â€**

---

### 2ï¸âƒ£ bindings åœ¨åšä»€ä¹ˆï¼Ÿ

ä»¥ `fs.readFile` ä¸ºä¾‹ï¼š

```js
fs.readFile('a.txt', cb)
```

çœŸå®æµç¨‹ï¼š

```text
JS è°ƒç”¨
â†“
C++ bindingsï¼ˆå‚æ•°æ ¡éªŒ / è½¬æ¢ï¼‰
â†“
libuv æäº¤ IO ä»»åŠ¡
â†“
OS / çº¿ç¨‹æ± 
â†“
libuv å›è°ƒ
â†“
C++ bindings
â†“
JS å›è°ƒï¼ˆPromise / callbackï¼‰
```

---

### 3ï¸âƒ£ bindings æ˜¯ Node æ€§èƒ½çš„â€œä¸­æ¢ç¥ç»â€

* JS â†” C++ é¢‘ç¹åˆ‡æ¢
* å‚æ•°è¶Šå¤šã€å¯¹è±¡è¶Šå¤æ‚ï¼Œæˆæœ¬è¶Šé«˜
* å¤§å¯¹è±¡åºåˆ—åŒ–æ˜¯éšå½¢æ€§èƒ½æ€æ‰‹

ğŸ‘‰ **ä¸ºä»€ä¹ˆ Node ä¸é€‚åˆâ€œä¼ å¤§å¯¹è±¡ + é‡è®¡ç®—â€**

---

## å››ã€ä¸€æ¬¡å®Œæ•´è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¸²èµ·æ¥ï¼‰

### ä¾‹å­ï¼šHTTP è¯·æ±‚

```js
app.get('/user', async (req, res) => {
  const user = await db.query()
  res.json(user)
})
```

### åº•å±‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1ï¸âƒ£ socket äº‹ä»¶ â†’ libuv
2ï¸âƒ£ libuv é€šçŸ¥ Node â†’ JS å›è°ƒ
3ï¸âƒ£ JS ä»£ç åœ¨ V8 æ‰§è¡Œ
4ï¸âƒ£ await â†’ æ³¨å†Œ microtask
5ï¸âƒ£ db.query â†’ C++ bindings â†’ libuv
6ï¸âƒ£ IO å®Œæˆ â†’ libuv å›è°ƒ
7ï¸âƒ£ C++ â†’ JS Promise resolve
8ï¸âƒ£ V8 ç»§ç»­æ‰§è¡Œ JS
9ï¸âƒ£ å†™å› socket â†’ libuv

ğŸ‘‰ **V8 åªåœ¨ç¬¬ 3ã€8 æ­¥å¿™**

---

## äº”ã€ä¸ºä»€ä¹ˆè¿™å¥—æ¶æ„â€œå¤©ç”Ÿå IOâ€ï¼Ÿ

### æ ¸å¿ƒåŸå› åªæœ‰ä¸€å¥è¯ï¼š

> **Node æŠŠâ€œç­‰ IOâ€ä»â€œç®— JSâ€ä¸­å½»åº•å‰¥ç¦»äº†**

å¯¹æ¯”ä¼ ç»Ÿæ¨¡å‹ï¼š

| æ¨¡å‹    | é—®é¢˜             |
| ----- | -------------- |
| å¤šçº¿ç¨‹é˜»å¡ | çº¿ç¨‹è¢« IO å ä½      |
| Node  | JS æ°¸è¿œåªå¹²â€œå€¼å¾—å¹²çš„äº‹â€ |

---

## å…­ã€è¿™å¥—æ¶æ„å¸¦æ¥çš„å·¥ç¨‹ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰

### âœ… Node éå¸¸æ“…é•¿

* é«˜å¹¶å‘ IO
* API èšåˆ
* BFF / SSRï¼ˆè½»æ¸²æŸ“ï¼‰
* WebSocket / SSE

---

### âŒ Node å¤©ç”Ÿä¸æ“…é•¿

* CPU å¯†é›†
* åŒæ­¥è®¡ç®—
* å¤§å¯¹è±¡é¢‘ç¹è¿›å‡º C++ è¾¹ç•Œ

---

### âš ï¸ çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆé€šå¸¸åœ¨ï¼š

* V8 è¢«åŒæ­¥ä»£ç å¡ä½
* libuv çº¿ç¨‹æ± è¢«æ‰“æ»¡
* C++ â†” JS æ¥å›æ‹·è´è¿‡å¤š

---

## ä¸ƒã€ä¸€å¥â€œæ¶æ„çº§æ€»ç»“â€ï¼ˆå¯ä»¥å†™è¿›æ•™ç¨‹ï¼‰

> **V8 å†³å®š Node çš„â€œä¸Šé™â€
> libuv å†³å®š Node çš„â€œå¹¶å‘â€
> C++ bindings å†³å®š Node çš„â€œä»£ä»·â€**

---

