## util Â· events Â· timers Â· perf_hooks

![Image](https://media.geeksforgeeks.org/wp-content/uploads/20200224050909/nodejs2.png)

![Image](https://media.licdn.com/dms/image/v2/D4D12AQEKjPIr6DJBqA/article-cover_image-shrink_600_2000/B4DZWfRbm9H4Ac-/0/1742133902273?e=2147483647\&t=qRSd1Bc2TvOLIQwImkwGB7H9-Bt1-NKrypM6Cc7Liw4\&v=beta)

![Image](https://blog.appsignal.com/images/blog/2024-04/api-request.png)

> **è¿™å››ä¸ªæ¨¡å—ä¸æ˜¯â€œä¸šåŠ¡æ¨¡å—â€**
> å®ƒä»¬æ§åˆ¶çš„æ˜¯ï¼š
> ğŸ‘‰ **å¼‚æ­¥æ¨¡å‹ã€æ—¶é—´è°ƒåº¦ã€äº‹ä»¶æœºåˆ¶ã€æ€§èƒ½è§‚æµ‹**

---

## ä¸€ã€å…ˆç»™æ•´ä½“å®šä½ï¼ˆéå¸¸é‡è¦ï¼‰

```text
util        â†’ å·¥å…·ä¸â€œæ¡¥æ¥â€ï¼ˆpromisify / inspectï¼‰
events      â†’ äº‹ä»¶æ¨¡å‹ï¼ˆå‘å¸ƒ-è®¢é˜…ï¼‰
timers      â†’ æ—¶é—´è°ƒåº¦ï¼ˆäº‹ä»¶å¾ªç¯å…¥å£ï¼‰
perf_hooks  â†’ æ€§èƒ½åº¦é‡ï¼ˆç²¾ç¡®åˆ° nsï¼‰
```

**ä¸€å¥è¯åŸåˆ™ï¼š**

> **events / timers å†³å®šâ€œç¨‹åºæ€ä¹ˆè·‘â€
> perf_hooks å†³å®šâ€œä½ çŸ¥ä¸çŸ¥é“å®ƒè·‘å¾—æ€ä¹ˆæ ·â€**

---

## äºŒã€utilï¼šNode çš„â€œé€‚é…ä¸å…œåº•å·¥å…·ç®±â€

### 1ï¸âƒ£ util çš„çœŸå®ç”¨é€”ï¼ˆä¸æ˜¯æ‚é¡¹ï¼‰

#### âœ… util.promisifyï¼ˆæœ€å¸¸ç”¨ï¼‰

```js
const { promisify } = require('util')
const readFileAsync = promisify(fs.readFile)
```

**è§£å†³ä»€ä¹ˆï¼Ÿ**

* è€ callback API
* ä¸ async/await ç»Ÿä¸€

ğŸ‘‰ **æœ¬è´¨ï¼šæ¥å£é£æ ¼ç»Ÿä¸€**

---

#### âœ… util.inspectï¼ˆçº¿ä¸Šæ’éšœç¥å™¨ï¼‰

```js
console.log(util.inspect(obj, { depth: 3 }))
```

**æ¯” JSON.stringify å¥½åœ¨å“ªï¼Ÿ**

* ä¸æ€•å¾ªç¯å¼•ç”¨
* ä¸ä¸¢ç±»å‹
* å¯æ§æ·±åº¦

ğŸ‘‰ **æ—¥å¿— / Debug å¿…å¤‡**

---

### 2ï¸âƒ£ util ä¸è¯¥å¹²ä»€ä¹ˆ

* âŒ å½“ä¸šåŠ¡å·¥å…·åº“
* âŒ é‡åº¦ä¾èµ– util.types åˆ¤æ–­ä¸šåŠ¡é€»è¾‘

---

### 3ï¸âƒ£ å·¥ç¨‹ç»“è®º

> **util è§£å†³çš„æ˜¯â€œå…¼å®¹é—®é¢˜â€ï¼Œä¸æ˜¯â€œä¸šåŠ¡é—®é¢˜â€**

---

## ä¸‰ã€eventsï¼šNode çš„äº‹ä»¶æ¨¡å‹ï¼ˆä¸æ˜¯å¼‚æ­¥é­”æ³•ï¼‰

### 1ï¸âƒ£ EventEmitter æ˜¯ä»€ä¹ˆï¼Ÿ

```js
const EventEmitter = require('events')
```

> **ä¸€ä¸ªåŒæ­¥çš„å‘å¸ƒ-è®¢é˜…æœºåˆ¶**

â— **éå¸¸å…³é”®ï¼ševents é»˜è®¤æ˜¯åŒæ­¥æ‰§è¡Œ**

---

### 2ï¸âƒ£ å¸¸è§è¯¯è§£ï¼ˆçº¿ä¸Šäº‹æ•…æºå¤´ï¼‰

```js
emitter.on('done', () => {
  heavyTask() // âŒ åŒæ­¥é˜»å¡
})
```

ğŸ‘‰ è§¦å‘äº‹ä»¶çš„é‚£ä¸€åˆ»ï¼š

* æ‰€æœ‰ listener åŒæ­¥æ‰§è¡Œ
* ä¼šç›´æ¥é˜»å¡å½“å‰è°ƒç”¨æ ˆ

---

### 3ï¸âƒ£ æ­£ç¡®ä½¿ç”¨å§¿åŠ¿

#### âœ… äº‹ä»¶åªåšâ€œé€šçŸ¥â€ï¼Œä¸åšâ€œé‡æ´»â€

```js
emitter.on('done', async () => {
  await queueTask()
})
```

---

### 4ï¸âƒ£ å¿…é¡»æŒæ¡çš„ä¸¤ä¸ªå‘

#### âŒ å†…å­˜æ³„æ¼ï¼ˆç›‘å¬å™¨å¿˜è®°ç§»é™¤ï¼‰

```js
emitter.on('event', handler)
```

ğŸ‘‰ é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ + åŠ¨æ€æ³¨å†Œ = æ³„æ¼

```js
emitter.removeListener('event', handler)
```

---

#### âŒ MaxListeners è­¦å‘Šä¸æ˜¯â€œå™ªéŸ³â€

```text
MaxListenersExceededWarning
```

ğŸ‘‰ **è¿™æ˜¯å†…å­˜æ³„æ¼é¢„è­¦ï¼Œä¸æ˜¯æ€§èƒ½é—®é¢˜**

---

### 5ï¸âƒ£ æœåŠ¡ç«¯å®šä½

| åœºæ™¯    | æ˜¯å¦æ¨è |
| ----- | ---- |
| æ¨¡å—å†…è§£è€¦ | âœ…    |
| è¯·æ±‚çº§é€»è¾‘ | âŒ    |
| è·¨æœåŠ¡é€šä¿¡ | âŒ    |

---

## å››ã€timersï¼šæ—¶é—´è°ƒåº¦ â‰  å®šæ—¶å™¨

### 1ï¸âƒ£ timers åœ¨ Node ä¸­çš„çœŸå®åœ°ä½

```js
setTimeout(fn)
setImmediate(fn)
process.nextTick(fn)
```

å®ƒä»¬ä¸æ˜¯â€œå»¶è¿Ÿå·¥å…·â€ï¼Œè€Œæ˜¯ï¼š

> **äº‹ä»¶å¾ªç¯çš„â€œæ’é˜Ÿå…¥å£â€**

---

### 2ï¸âƒ£ æ‰§è¡Œä¼˜å…ˆçº§ï¼ˆNode è§†è§’ï¼‰

```text
process.nextTick
â†“
Promise.then (microtask)
â†“
timers (setTimeout)
â†“
poll
â†“
check (setImmediate)
```

---

### 3ï¸âƒ£ ä¸‰ä¸ªæœ€å®¹æ˜“å†™é”™çš„ç‚¹

#### âŒ nextTick æ»¥ç”¨

```js
while (true) {
  process.nextTick(fn)
}
```

ğŸ‘‰ **äº‹ä»¶å¾ªç¯é¥¿æ­»ï¼ŒIO æ°¸è¿œè·‘ä¸åˆ°**

---

#### âŒ setTimeout(fn, 0) â‰  ç«‹å³æ‰§è¡Œ

* åªæ˜¯â€œæœ€æ—©ä¸‹ä¸€è½®â€
* å—äº‹ä»¶å¾ªç¯çŠ¶æ€å½±å“

---

#### âŒ ç”¨ timer åšé«˜ç²¾åº¦è°ƒåº¦

* ä¸å¯é 
* æ¼‚ç§»ä¸¥é‡

---

### 4ï¸âƒ£ å·¥ç¨‹å»ºè®®

* nextTickï¼šä»…ç”¨äº**å†…éƒ¨ä¿®å¤**
* setImmediateï¼šIO å›è°ƒåè°ƒåº¦
* setTimeoutï¼šä¸šåŠ¡å»¶è¿Ÿï¼Œä¸åšç²¾åº¦ä¿è¯

---

## äº”ã€perf_hooksï¼šNode çš„â€œç²¾å¯†ä»ªè¡¨ç›˜â€

### 1ï¸âƒ£ perf_hooks æ˜¯ä»€ä¹ˆï¼Ÿ

```js
const { performance } = require('perf_hooks')
```

> **é«˜ç²¾åº¦ï¼ˆns çº§ï¼‰çš„æ€§èƒ½æµ‹é‡å·¥å…·**

---

### 2ï¸âƒ£ ä¸ Date.now() çš„æ ¹æœ¬åŒºåˆ«

|     | Date.now | performance.now |
| --- | -------- | --------------- |
| ç²¾åº¦  | ms       | Î¼s/ns           |
| ç¨³å®šæ€§ | å—ç³»ç»Ÿæ—¶é—´å½±å“  | å•è°ƒé€’å¢            |
| é€‚åˆ  | å±•ç¤º       | æ€§èƒ½åˆ†æ            |

---

### 3ï¸âƒ£ Node æœåŠ¡ç«¯å¿…ç”¨åœºæ™¯

#### âœ… å•è¯·æ±‚åˆ†æ®µè€—æ—¶

```js
performance.mark('start')
// logic
performance.mark('end')
performance.measure('api', 'start', 'end')
```

---

#### âœ… äº‹ä»¶å¾ªç¯å»¶è¿Ÿç›‘æ§ï¼ˆéå¸¸é‡è¦ï¼‰

```js
const { monitorEventLoopDelay } = require('perf_hooks')
const h = monitorEventLoopDelay()
h.enable()
```

ğŸ‘‰ èƒ½ç›´æ¥å‘Šè¯‰ä½ ï¼š

* Node æ˜¯å¦è¢«é˜»å¡
* CPU æ˜¯å¦åƒç´§

---

### 4ï¸âƒ£ perf_hooks çš„å·¥ç¨‹ä»·å€¼

* æ¯”æ—¥å¿—å‡†
* æ¯” APM è½»
* å¯å†…åµŒ

---

## å…­ã€å››ä¸ªæ¨¡å—çš„â€œé”™è¯¯ä½¿ç”¨åæœè¡¨â€

| æ¨¡å—         | ç”¨é”™ä¼šæ€æ ·          |
| ---------- | -------------- |
| util       | æŠ€æœ¯å€º            |
| events     | åŒæ­¥é˜»å¡ / å†…å­˜æ³„æ¼    |
| timers     | äº‹ä»¶å¾ªç¯é¥¿æ­»         |
| perf_hooks | ä¸ç”¨ â†’ ä½ æ°¸è¿œä¸çŸ¥é“æ…¢åœ¨å“ª |

---

## ä¸ƒã€Node æœåŠ¡ç«¯â€œè¿è¡Œæ—¶é“å¾‹â€

### âŒ ç¦æ­¢

* åœ¨ EventEmitter listener é‡Œè·‘é‡é€»è¾‘
* æ»¥ç”¨ nextTick
* ç”¨ setTimeout åšç²¾ç¡®æ§åˆ¶
* ç”¨ Date.now åšæ€§èƒ½åˆ†æ

---

### âœ… æ¨è

* util.promisify ç»Ÿä¸€å¼‚æ­¥é£æ ¼
* events åªä¼ ä¿¡å·
* timers åªåšè°ƒåº¦
* perf_hooks åšæ€§èƒ½äº‹å®æ¥æº

---

## å…«ã€ä¸€å¥è¯æ€»ç»“ï¼ˆé€‚åˆå†™è¿›æ•™ç¨‹ï¼‰

> **events å†³å®šç»“æ„
> timers å†³å®šèŠ‚å¥
> perf_hooks å†³å®šçœŸç›¸
> util åªæ˜¯ç²˜åˆå‰‚**

---
