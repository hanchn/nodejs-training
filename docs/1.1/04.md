# Node.js æ·±æ‹·è´è¯¥æ€Žä¹ˆåšï¼ˆå·¥ç¨‹çº§ç­”æ¡ˆï¼‰

> **ç»“è®ºå…ˆè¡Œï¼š**
> âŒ ä¸å­˜åœ¨â€œé€šç”¨å®‰å…¨çš„æ·±æ‹·è´â€
> âœ… åªæœ‰**æŒ‰åœºæ™¯é€‰æ‹©çš„æ·±æ‹·è´ç­–ç•¥**

---

## ä¸€ã€ç¬¬ä¸€æ­¥ï¼šä½ çœŸçš„éœ€è¦â€œæ·±æ‹·è´â€å—ï¼Ÿ

å…ˆé—®è‡ªå·± 3 ä¸ªé—®é¢˜ï¼š

1ï¸âƒ£ æ˜¯å¦è·¨è¯·æ±‚å…±äº«ï¼Ÿ
2ï¸âƒ£ æ˜¯å¦ä¼šè¢«ä¿®æ”¹ï¼Ÿ
3ï¸âƒ£ æ˜¯å¦å­˜åœ¨åµŒå¥—å¼•ç”¨ï¼Ÿ

| åœºæ™¯         | æ˜¯å¦éœ€è¦æ·±æ‹·è´   |
| ---------- | --------- |
| åªè¯»é…ç½®       | âŒï¼ˆfreezeï¼‰ |
| è¯·æ±‚æ€æ•°æ®      | âœ…         |
| DTO / è¾“å‡ºæ•°æ® | âš ï¸ï¼ˆéƒ¨åˆ†ï¼‰    |
| cache æ¨¡æ¿   | âœ…         |

> **èƒ½ freeze å°±åˆ«æ‹·ï¼Œèƒ½æ–°å»ºå°±åˆ« clone**

---

## äºŒã€Node.js å®˜æ–¹æŽ¨èæ–¹æ¡ˆï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

### âœ… æ–¹æ¡ˆ 1ï¼š`structuredClone`ï¼ˆNode 17+ï¼‰

```js
const copy = structuredClone(obj)
```

### ä¸ºä»€ä¹ˆå®ƒæ˜¯é¦–é€‰ï¼Ÿ

* æ”¯æŒå¾ªçŽ¯å¼•ç”¨
* æ”¯æŒ Map / Set / Date / RegExp
* ä¸ä¸¢ç±»åž‹
* æ€§èƒ½å¯æŽ§
* **ä¸ä¼š silent fail**

### âŒ ä¸æ”¯æŒ

* function
* class å®žä¾‹æ–¹æ³•
* prototype è¡Œä¸º

ðŸ“Œ **é€‚åˆåœºæ™¯**

* API è¯·æ±‚æ€æ•°æ®
* é…ç½®æ¨¡æ¿
* ä¸­ç­‰ä½“é‡å¯¹è±¡

---

## ä¸‰ã€ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæœ‰æ˜Žç¡®è¾¹ç•Œæ—¶æ‰ç”¨ï¼‰

### âš ï¸ æ–¹æ¡ˆ 2ï¼šJSON æ·±æ‹·è´ï¼ˆæžå…¶æœ‰é™ï¼‰

```js
JSON.parse(JSON.stringify(obj))
```

#### ä»…åœ¨ä»¥ä¸‹æ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ä½¿ç”¨ï¼š

* æ— å¾ªçŽ¯å¼•ç”¨
* çº¯ POJO
* ä¸å« Date / BigInt / undefined
* å¯¹æ€§èƒ½ä¸æ•æ„Ÿ

ðŸ“Œ **åªé€‚åˆ demo / mock / test**

---

## å››ã€é«˜æ€§èƒ½ã€å¯æŽ§æ‹·è´ï¼ˆç”Ÿäº§æŽ¨èï¼‰

### âœ… æ–¹æ¡ˆ 3ï¼šæ‰‹å†™â€œç»“æž„æ„ŸçŸ¥â€æ·±æ‹·è´ï¼ˆæœ€æŽ¨èï¼‰

> **ä¸æ˜¯å…¨æ‹·ï¼Œè€Œæ˜¯åªæ‹·ä¼šè¢«æ”¹çš„å±‚**

### ç¤ºä¾‹ï¼ˆNode æœåŠ¡ç«¯å¸¸ç”¨ï¼‰

```js
function cloneRequestConfig(base, override) {
  return {
    ...base,
    headers: {
      ...base.headers,
      ...override.headers
    },
    params: {
      ...override.params
    }
  }
}
```

### ä¼˜ç‚¹

* æ˜Žç¡®æ‹·è´è¾¹ç•Œ
* æ€§èƒ½æœ€ä¼˜
* å¯è¯»æ€§å¼º
* ä¸å¯èƒ½è¯¯æ‹· request / response

ðŸ“Œ **è¿™æ˜¯æœåŠ¡ç«¯æœ€â€œå·¥ç¨‹åŒ–â€çš„è§£æ³•**

---

## äº”ã€class / å®žä¾‹å¯¹è±¡æ€Žä¹ˆæ‹·ï¼Ÿ

### âŒ é”™è¯¯å§¿åŠ¿

```js
const copy = structuredClone(service) // âŒ
```

### æ­£ç¡®åšæ³•ï¼šæ‹·æ•°æ®ï¼Œä¸æ‹·è¡Œä¸º

```js
class User {
  constructor(data) {
    Object.assign(this, data)
  }
}

const copy = new User({ ...userData })
```

> **Node ä¸­ï¼šå¯¹è±¡ = æ•°æ® + è¡Œä¸º**
> æ·±æ‹·è´åªé’ˆå¯¹ **æ•°æ®**

---

## å…­ã€å¾ªçŽ¯å¼•ç”¨å¯¹è±¡æ€Žä¹ˆåŠžï¼Ÿ

### âœ… åªèƒ½ç”¨ï¼š

* structuredClone
* è‡ªå®šä¹‰ WeakMap clone

```js
function deepClone(obj, map = new WeakMap()) {
  if (obj === null || typeof obj !== 'object') return obj
  if (map.has(obj)) return map.get(obj)

  const copy = Array.isArray(obj) ? [] : {}
  map.set(obj, copy)

  for (const key in obj) {
    copy[key] = deepClone(obj[key], map)
  }

  return copy
}
```

ðŸ“Œ **ä»…åœ¨ä½ éžå¸¸ç¡®å®šå¯¹è±¡ç»“æž„æ—¶ä½¿ç”¨**

---

## ä¸ƒã€æ€§èƒ½ä¸Žå®‰å…¨çš„é»„é‡‘åŽŸåˆ™ï¼ˆNode ä¸“å±žï¼‰

### ðŸš« æ°¸è¿œä¸è¦åšçš„äº‹

* å¯¹æ•´ä¸ª request åšæ·±æ‹·è´
* å¯¹ response åšæ·±æ‹·è´
* å¯¹å¤§å¯¹è±¡æ— è„‘ clone

---

### âœ… æŽ¨èç­–ç•¥æ€»ç»“è¡¨

| åœºæ™¯       | æŽ¨èæ–¹æ¡ˆ              |
| -------- | ----------------- |
| å…¨å±€é…ç½®     | `Object.freeze`   |
| è¯·æ±‚æ€ DTO  | `structuredClone` |
| API å‚æ•°ç»„åˆ | æ‰‹å†™ç»“æž„æ‹·è´            |
| æµ‹è¯•æ•°æ®     | JSON clone        |
| class å®žä¾‹ | æž„é€ æ–°å®žä¾‹             |
| å«å¾ªçŽ¯å¼•ç”¨    | structuredClone   |

---

## å…«ã€ä¸€å¥è¯ç»™å›¢é˜Ÿçš„â€œæ·±æ‹·è´å…±è¯†â€

> **æ·±æ‹·è´ä¸æ˜¯å®‰å…¨æ„Ÿï¼Œè€Œæ˜¯æˆæœ¬**
> **ä½ è¶Šæ™šå†³å®šæ‹·å“ªä¸€å±‚ï¼ŒNode å°±è¶Šå®¹æ˜“å‡ºé—®é¢˜**

